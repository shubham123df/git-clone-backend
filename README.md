# Intelligent Pull Request & Code Review Management System

A production-grade web application that centralizes pull request submission, reviewer workflows, approvals, audit logs, and deployment readiness tracking for software teams.

## Features

- **Authentication & RBAC**: JWT-based auth with roles (Admin, Developer, Reviewer, Release Manager) and permissions
- **Pull Request lifecycle**: Create, edit, status flow (Open → In Review → Changes Requested → Approved → Ready for Deployment → Deployed)
- **Reviewers**: Assign multiple reviewers, prevent duplicates, in-app notifications
- **Reviews**: Approve / Request changes / Reject with comments and timeline
- **Deployment readiness**: Approval status, pending reviews, checklist, CI, blockers, final readiness indicator
- **Notifications**: Async queue (Redis/Bull), in-app list, mark read
- **Audit logs**: Queryable log for PR/review/deployment events (Admin, Release Manager)
- **Webhooks**: GitHub and GitLab endpoints to sync PR status and CI results
- **Landing page**: Public product overview, features, workflow, Sign up / Sign in (dark mode, responsive)
- **Assigned Reviews**: Dedicated page for PRs assigned to you, with filters (Pending, Changes requested, Approved)
- **Settings**: Profile (name) and repository access – add/update/revoke GitHub or GitLab tokens (encrypted at rest, never exposed in API)
- **Dark mode**: UI theme toggle

## Architecture

- **Backend**: NestJS (Node.js + TypeScript), Prisma ORM, PostgreSQL, Redis (Bull queue)
- **Frontend**: React 18, TypeScript, Vite, Zustand, TailwindCSS
- **API**: REST with version prefix `/api/v1`

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md), [docs/DATABASE_SCHEMA.md](docs/DATABASE_SCHEMA.md), and [docs/API_ROUTES.md](docs/API_ROUTES.md) for details.

## Prerequisites

- Node.js 20+
- PostgreSQL 15+
- Redis 7+
- (Optional) Docker & Docker Compose

## Quick start (local)

### 1. Backend

```bash
cd backend
cp .env.example .env
# Edit .env: set DATABASE_URL, JWT_ACCESS_SECRET, JWT_REFRESH_SECRET (min 32 chars each), REDIS_HOST/PORT.
# Optional: TOKEN_ENCRYPTION_KEY (64 hex chars) for encrypting GitHub/GitLab tokens; see docs/TOKEN_STORAGE_STRATEGY.md.
npm install
npx prisma migrate dev --name init
npm run seed
npm run start:dev
```

Backend runs at `http://localhost:3010` (port 3010 to avoid conflict with other local services). API: `http://localhost:3010/api/v1`.

### 2. Frontend

```bash
cd frontend
npm install
npm run dev
```

Frontend runs at **http://localhost:5190** (or the next free port Vite prints). It proxies `/api` to the backend at 3010. **Use the URL Vite shows**—do not use 5173 if you have other apps (e.g. Risk Engine) on that port.

### 3. First user

- Open the frontend URL (e.g. `http://localhost:5190/register`) and create an account (default role: Developer).
- To test Admin/Release Manager, update the user's role in DB or run a seed that creates an admin user.

## Deploy on Render

The repo includes a [Render Blueprint](https://render.com/docs/blueprint-spec) for one-click deploy.

1. **Push the repo to GitHub/GitLab** (must contain `render.yaml` at the root).
2. **Log in to [Render](https://render.com)** and create a new **Blueprint** (Dashboard → New → Blueprint).
3. **Connect the repository** that contains this project.
4. **Apply the Blueprint**. Render will create:
   - A **PostgreSQL** database (`pr-review-db`)
   - A **Redis** (Key Value) instance (`pr-review-redis`)
   - One **Web Service** (`pr-review-app`) that builds both frontend and backend and serves them from a single URL
5. **First deploy**: The build runs frontend → copies output to `backend/public` → builds backend. Pre-deploy runs migrations and seeds roles. No manual seed needed.
6. **Open the service URL** (e.g. `https://pr-review-app.onrender.com`). Register and use the app.

**Notes:**

- **Free tier**: Database and Redis use free plans; the web service uses the free instance (spins down after inactivity; cold starts may take ~30s).
- **Secrets**: `JWT_ACCESS_SECRET` and `JWT_REFRESH_SECRET` are auto-generated by the Blueprint. To set your own, override them in the service’s Environment tab.
- **Health check**: Render pings `/api/v1/health` for zero-downtime deploys.
- **Custom domain**: Add your domain in the service’s Settings → Custom Domains.

## Docker

```bash
# Start PostgreSQL + Redis + Backend + Frontend
docker-compose up -d postgres redis
# Run migrations and seed (one-time)
cd backend && npx prisma migrate deploy && npm run seed
docker-compose up -d backend
# Frontend (optional; for production build served by nginx)
docker-compose up -d frontend
```

Or run everything with one command (migrations run on backend startup):

```bash
docker-compose up -d
# Then run seed once: docker-compose exec backend npm run seed
```

Environment variables for backend can be set in `.env` or in `docker-compose.yml` (see `backend/.env.example`).

## Environment variables

### Backend (`backend/.env`)

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string |
| `JWT_ACCESS_SECRET` | Secret for access tokens (min 32 chars) |
| `JWT_REFRESH_SECRET` | Secret for refresh tokens (min 32 chars) |
| `JWT_ACCESS_EXPIRY` | e.g. `15m` |
| `JWT_REFRESH_EXPIRY` | e.g. `7d` |
| `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD` | Redis for Bull queue |
| `PORT` | Server port (default 3000) |
| `API_PREFIX` | Default `api/v1` |
| `FRONTEND_URL` | Allowed CORS origin (e.g. `http://localhost:5173`) |
| `GITHUB_WEBHOOK_SECRET`, `GITLAB_WEBHOOK_SECRET` | Optional, for webhook signature verification |

### Frontend

- Development: Vite proxies `/api` to the backend URL (see `vite.config.ts`).
- Production: Set `VITE_API_BASE` if API is on a different host (optional).

## Testing

- **Backend**: `cd backend && npm test` (unit), `npm run test:e2e` (e2e with test DB/Redis).
- **Frontend**: Add `vitest` or `jest` and run tests as needed.

See [docs/TESTING_STRATEGY.md](docs/TESTING_STRATEGY.md).

## CI/CD (suggested)

- Lint: `npm run lint` (backend and frontend).
- Typecheck: `tsc --noEmit` (backend and frontend).
- Unit tests: `npm test` in backend.
- Build: `npm run build` in backend and frontend.
- Docker: Build backend and frontend images; run migrations in deployment job or on container start.

## License

MIT.
